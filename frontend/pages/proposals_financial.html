<div class="section">
  <h2>Financial Proposal</h2>
  <table id="fp_table">
    <thead>
      <tr>
        <th>Heading</th><th>Line Item</th><th>Unit</th><th>Price / Unit</th><th>% Cofinancing</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addFpRow()">Add Line</button>
  <button onclick="submitFinancial()">Submit Financial Proposal</button>
</div>
<script>
function addFpRow() {
  const tb = document.querySelector("#fp_table tbody");
  const tr = document.createElement("tr");
  ["heading","item","unit","price","cofin"].forEach(n=>{
    const td=document.createElement("td");
    td.innerHTML = "<input>";
    tr.appendChild(td);
  });
  tb.appendChild(tr);
}
async function submitFinancial() {
  const rows = Array.from(document.querySelectorAll("#fp_table tbody tr"));
  const lines = rows.map(tr => {
    const [heading,item,unit,price,cofin] = Array.from(tr.querySelectorAll("input")).map(i=>i.value);
    return { heading,item,unit,price:parseFloat(price||0),cofinancing:parseFloat(cofin||0) };
  });
  const res = await postJSON("/financial-proposal", { lines });
  if (res && !res.detail) showNotice("success", "Financial proposal submitted");
  else showNotice("error", "Error submitting financial proposal");
}
addFpRow();
</script>
